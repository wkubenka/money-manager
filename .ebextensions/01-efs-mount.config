packages:
  yum:
    amazon-efs-utils: []

commands:
  01_mount_efs:
    command: |
      EFS_ID=$(/opt/elasticbeanstalk/bin/get-config environment -k EFS_ID)
      if [ -z "$EFS_ID" ]; then
        echo "EFS_ID environment variable not set, skipping EFS mount"
        exit 0
      fi
      mkdir -p /mnt/efs
      if ! mountpoint -q /mnt/efs; then
        mount -t efs -o tls "$EFS_ID":/ /mnt/efs
      fi
      # Ensure it persists across reboots
      if ! grep -q "$EFS_ID" /etc/fstab; then
        echo "$EFS_ID:/ /mnt/efs efs _netdev,tls 0 0" >> /etc/fstab
      fi
    test: "! mountpoint -q /mnt/efs"
